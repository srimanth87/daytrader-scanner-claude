<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>NDX100 â€” Day Trading Momentum Scanner</title>
<link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@300;400;500;600;700&family=Bebas+Neue&display=swap" rel="stylesheet">
<style>
:root{
  --bg:#04070a; --card:#070d12; --border:#0d1f2d;
  --green:#00ff88; --red:#ff3355; --yellow:#ffd700;
  --accent:#00d4ff; --purple:#c084fc; --orange:#fb923c;
  --dim:#3a5a6a; --text:#ddeeff; --muted:#1a3040;
  --mono:'JetBrains Mono',monospace;
}
*{box-sizing:border-box;margin:0;padding:0}
body{background:var(--bg);color:var(--text);font-family:var(--mono);min-height:100vh}

/* grid bg */
.gridbg{position:fixed;inset:0;pointer-events:none;z-index:0;opacity:.18;
  background-image:
    linear-gradient(rgba(0,212,255,0.3) 1px,transparent 1px),
    linear-gradient(90deg,rgba(0,212,255,0.3) 1px,transparent 1px);
  background-size:40px 40px}

.wrap{max-width:1340px;margin:0 auto;padding:24px 20px;position:relative;z-index:1}

/* â”€â”€ Header â”€â”€ */
.hdr{display:flex;justify-content:space-between;align-items:flex-end;
  border-bottom:1px solid var(--border);padding-bottom:16px;margin-bottom:18px}
.title{font-family:'Bebas Neue',sans-serif;font-size:48px;line-height:1;
  background:linear-gradient(135deg,var(--accent),var(--green));
  -webkit-background-clip:text;background-clip:text;color:transparent;
  letter-spacing:0.05em}
.sub{font-size:9px;color:var(--dim);letter-spacing:0.2em;margin-top:5px;text-transform:uppercase}
.hdr-right{display:flex;flex-direction:column;align-items:flex-end;gap:8px}
.scan-btn{
  font-family:'Bebas Neue',sans-serif;font-size:18px;letter-spacing:0.12em;
  background:var(--green);color:#000;border:none;padding:12px 32px;
  cursor:pointer;transition:all .2s;box-shadow:0 0 24px rgba(0,255,136,0.25)}
.scan-btn:hover{background:#00ffaa;box-shadow:0 0 40px rgba(0,255,136,0.5)}
.scan-btn:disabled{background:var(--muted);color:var(--dim);cursor:not-allowed;box-shadow:none}
.market-status{display:flex;align-items:center;gap:7px;font-size:10px}
.mdot{width:7px;height:7px;border-radius:50%;animation:blink 2s infinite}
@keyframes blink{0%,100%{opacity:1}50%{opacity:.25}}

/* â”€â”€ Strategy legend â”€â”€ */
.legend{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:16px}
.leg{display:flex;align-items:center;gap:6px;background:var(--card);
  border:1px solid var(--border);padding:5px 11px;border-radius:2px;font-size:10px;color:var(--dim)}
.ldot{width:6px;height:6px;border-radius:50%}

/* â”€â”€ Regime banner â”€â”€ */
.regime{display:flex;gap:2px;margin-bottom:16px}
.reg-card{flex:1;background:var(--card);border:1px solid var(--border);
  padding:12px 16px;display:flex;align-items:center;gap:10px;font-size:11px}
.reg-icon{font-size:18px}
.reg-val{font-size:13px;font-weight:700}
.reg-lbl{font-size:9px;color:var(--dim);letter-spacing:0.1em;text-transform:uppercase}

/* â”€â”€ Progress â”€â”€ */
.prog-wrap{margin-bottom:12px;display:none}
.prog-wrap.on{display:block}
.prog-lbl{font-size:9px;color:var(--dim);letter-spacing:0.08em;margin-bottom:5px;display:flex;justify-content:space-between}
.prog-bg{height:2px;background:var(--muted);border-radius:2px;overflow:hidden}
.prog-fill{height:100%;background:linear-gradient(90deg,var(--accent),var(--green));border-radius:2px;transition:width .3s}

/* â”€â”€ Log â”€â”€ */
.log{background:var(--card);border:1px solid var(--border);padding:10px 14px;
  max-height:110px;overflow:auto;font-size:10px;line-height:1.9;margin-bottom:14px;display:none}
.log.on{display:block}
.lok{color:var(--green)} .lerr{color:var(--red)} .linfo{color:var(--accent)} .lwarn{color:var(--yellow)}

/* â”€â”€ Stats â”€â”€ */
.stats{display:grid;grid-template-columns:repeat(6,1fr);gap:1px;background:var(--border);margin-bottom:16px}
.stat{background:var(--card);padding:14px 10px;text-align:center}
.snum{font-family:'Bebas Neue',sans-serif;font-size:32px;line-height:1;color:var(--text)}
.snum.g{color:var(--green)} .snum.y{color:var(--yellow)} .snum.p{color:var(--purple)} .snum.a{color:var(--accent)}
.slbl{font-size:8px;color:var(--dim);letter-spacing:0.15em;text-transform:uppercase;margin-top:4px}

/* â”€â”€ Table â”€â”€ */
.tbl-outer{background:var(--card);border:1px solid var(--border);overflow:hidden}

.thead,.trow{
  display:grid;
  grid-template-columns: 50px 90px 180px 100px 75px 80px 90px 85px 85px 80px 75px;
  border-bottom:1px solid var(--border)}
.thead{background:rgba(0,212,255,0.04)}
.thead>div{padding:9px 10px;font-size:9px;color:var(--dim);letter-spacing:0.15em;text-transform:uppercase}
.trow{background:var(--card);transition:background .15s;position:relative}
.trow:hover{background:#0a1520}
.trow:last-child{border-bottom:none}
.trow.fadeIn{animation:fadeIn .45s ease both}
@keyframes fadeIn{from{opacity:0;transform:translateX(-6px)}to{opacity:1;transform:translateX(0)}}

.cell{padding:12px 10px;display:flex;align-items:center;font-size:11px;border-right:1px solid rgba(13,31,45,.7)}
.cell:last-child{border-right:none}
.cell.col{flex-direction:column;align-items:flex-start;gap:2px}

.rankbar{position:absolute;left:0;top:0;bottom:0;width:3px}

/* cells */
.rnum{font-family:'Bebas Neue',sans-serif;font-size:24px;line-height:1}
.rnum.gold{color:#f59e0b} .rnum.silver{color:#94a3b8} .rnum.bronze{color:#b45309}
.tsym{font-family:'Bebas Neue',sans-serif;font-size:17px;letter-spacing:.04em;color:var(--text)}
.tname{font-size:9px;color:var(--dim);margin-top:1px}

.sig-main{font-size:11px;font-weight:600}
.sig-tags{display:flex;gap:4px;flex-wrap:wrap;margin-top:4px}
.tag{font-size:8px;padding:2px 6px;border-radius:2px;letter-spacing:.06em;font-weight:600}
.tg{background:rgba(0,255,136,.1);color:var(--green);border:1px solid rgba(0,255,136,.2)}
.ty{background:rgba(255,215,0,.1);color:var(--yellow);border:1px solid rgba(255,215,0,.2)}
.tp{background:rgba(192,132,252,.1);color:var(--purple);border:1px solid rgba(192,132,252,.2)}
.ta{background:rgba(0,212,255,.1);color:var(--accent);border:1px solid rgba(0,212,255,.2)}
.tr{background:rgba(255,51,85,.1);color:var(--red);border:1px solid rgba(255,51,85,.2)}
.to{background:rgba(251,146,60,.1);color:var(--orange);border:1px solid rgba(251,146,60,.2)}

.pval{font-size:14px;font-weight:700;color:var(--text)}
.chg{font-size:11px;font-weight:700}
.chg.pos{color:var(--green)} .chg.neg{color:var(--red)}

.bar-mini{width:44px;height:3px;background:var(--muted);border-radius:2px;overflow:hidden;margin-top:4px}
.bar-fill{height:100%;border-radius:2px}
.bf-green{background:var(--green)} .bf-red{background:var(--red)}
.bf-yellow{background:var(--yellow)} .bf-purple{background:linear-gradient(90deg,#7c3aed,#c084fc)}
.bf-accent{background:linear-gradient(90deg,#0284c7,var(--accent))}
.bf-orange{background:var(--orange)}

.score-num{font-family:'Bebas Neue',sans-serif;font-size:28px;line-height:1}
.score-denom{font-size:9px;color:var(--dim)}
.score-bar{width:44px;height:2px;background:var(--muted);border-radius:2px;overflow:hidden;margin-top:4px}
.score-fill{height:100%;background:linear-gradient(90deg,var(--accent),var(--green))}

.msg{padding:50px;text-align:center;color:var(--dim);font-size:13px;letter-spacing:.05em}
.spin{display:inline-block;width:9px;height:9px;border:2px solid var(--dim);border-top-color:var(--green);
  border-radius:50%;animation:spin .8s linear infinite;margin-right:8px;vertical-align:middle}
@keyframes spin{to{transform:rotate(360deg)}}

.foot{margin-top:14px;font-size:9px;color:var(--muted);letter-spacing:.05em;display:flex;justify-content:space-between}
</style>
</head>
<body>
<div class="gridbg"></div>
<div class="wrap">

<!-- Header -->
<div class="hdr">
  <div>
    <div class="title">NDX100 DAY TRADER</div>
    <div class="sub">Mid-day Momentum Â· Breakout Scoring Â· Top 10 to Buy Now</div>
  </div>
  <div class="hdr-right">
    <button class="scan-btn" id="scanBtn" onclick="runScan()">&#9654; SCAN NOW</button>
    <div class="market-status">
      <div class="mdot" id="mdot" style="background:var(--dim)"></div>
      <span id="mtext" style="color:var(--dim)">READY</span>
      <span id="mtime" style="color:var(--dim);margin-left:8px"></span>
    </div>
  </div>
</div>

<!-- Strategy legend -->
<div class="legend">
  <div class="leg"><div class="ldot" style="background:var(--green)"></div>Intraday % gain (momentum)</div>
  <div class="leg"><div class="ldot" style="background:var(--yellow)"></div>Volume surge vs 20-day avg</div>
  <div class="leg"><div class="ldot" style="background:var(--accent)"></div>Relative strength vs SPY</div>
  <div class="leg"><div class="ldot" style="background:var(--purple)"></div>Price above VWAP (approx)</div>
  <div class="leg"><div class="ldot" style="background:var(--orange)"></div>Gap up held (open > prev close)</div>
  <div class="leg"><div class="ldot" style="background:var(--red)"></div>Range expansion (ATR)</div>
</div>

<!-- Market regime -->
<div class="regime" id="regime">
  <div class="reg-card"><div class="reg-icon">â³</div><div><div class="reg-val" id="spyReg" style="color:var(--dim)">â€”</div><div class="reg-lbl">SPY Today</div></div></div>
  <div class="reg-card"><div class="reg-icon">ğŸ“Š</div><div><div class="reg-val" id="spyVol" style="color:var(--dim)">â€”</div><div class="reg-lbl">SPY Vol Ratio</div></div></div>
  <div class="reg-card"><div class="reg-icon">ğŸŒ¡ï¸</div><div><div class="reg-val" id="mktRegime" style="color:var(--dim)">â€”</div><div class="reg-lbl">Market Regime</div></div></div>
  <div class="reg-card"><div class="reg-icon">âš¡</div><div><div class="reg-val" id="scanTime" style="color:var(--dim)">â€”</div><div class="reg-lbl">Scan Time</div></div></div>
</div>

<!-- Progress -->
<div class="prog-wrap" id="progWrap">
  <div class="prog-lbl"><span id="progLbl">Scanning...</span><span id="progPct">0%</span></div>
  <div class="prog-bg"><div class="prog-fill" id="progFill" style="width:0%"></div></div>
</div>

<!-- Log -->
<div class="log" id="logBox"></div>

<!-- Stats -->
<div class="stats">
  <div class="stat"><div class="snum" id="sScanned">â€”</div><div class="slbl">Scanned</div></div>
  <div class="stat"><div class="snum g" id="sGainers">â€”</div><div class="slbl">Gaining &gt;1%</div></div>
  <div class="stat"><div class="snum y" id="sVolSurge">â€”</div><div class="slbl">Vol Surge &gt;1.5x</div></div>
  <div class="stat"><div class="snum a" id="sRS">â€”</div><div class="slbl">Beats SPY</div></div>
  <div class="stat"><div class="snum p" id="sGapUp">â€”</div><div class="slbl">Gap Up Held</div></div>
  <div class="stat"><div class="snum" id="sAvgChg">â€”</div><div class="slbl">Avg Chg%</div></div>
</div>

<!-- Table -->
<div class="tbl-outer">
  <div class="thead">
    <div>#</div><div>Ticker</div><div>Signal</div><div>Price</div>
    <div>Chg%</div><div>Vol Ratio</div><div>Rel Str</div>
    <div>Gap%</div><div>Intra Range</div><div>VWAP</div><div>Score</div>
  </div>
  <div id="tbody"><div class="msg">Press SCAN NOW to load live momentum data</div></div>
</div>

<div class="foot">
  <span>Finnhub: live quote + 5-min candles &nbsp;|&nbsp; Yahoo Finance: daily history for vol ratio + ATR &nbsp;|&nbsp; Not financial advice</span>
  <span id="footTime"></span>
</div>
</div>

<script>
// â”€â”€ Keys â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const FH  = "d6bl5k9r01qp4lhvspn0d6bl5k9r01qp4lhvspng";
const FH_BASE  = "https://finnhub.io/api/v1";
const YH_BASE  = "https://query1.finance.yahoo.com/v8/finance/chart";

// â”€â”€ Telegram Alert Config â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const TG_TOKEN   = "8570415382:AAF7q0vmO_Vy-KEar2r48fRvoAuLzFAXlZY";
const TG_CHAT_ID = "1026720092";

async function sendTelegramAlert(stock) {
  const s = stock._score;
  const emoji = s.pts >= 11 ? "ğŸ”¥" : "âš¡";
  const signal = s.pts >= 11 ? "STRONG MOMENTUM" : "MOMENTUM";
  const tags = s.tags.map(t => t.t).join(" Â· ");

  const msg = `${emoji} *BUY SIGNAL â€” DAY TRADER*
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
ğŸ“Œ *${stock.sym}* â€” ${stock.name}
ğŸ’° Price: $${stock.price.toFixed(2)}
ğŸ“ˆ Change: ${stock.chgPct >= 0 ? "+" : ""}${stock.chgPct.toFixed(2)}%
â­ Score: ${s.pts}/${MAX_PTS} â€” ${signal}
ğŸ“Š ${tags}
â° ${new Date().toLocaleTimeString()}
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€`;

  try {
    await fetch(`https://api.telegram.org/bot${TG_TOKEN}/sendMessage`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ chat_id: TG_CHAT_ID, text: msg, parse_mode: "Markdown" })
    });
    log(`ğŸ“² Telegram alert sent â†’ ${stock.sym}`, "linfo");
  } catch(e) {
    log(`âš  Telegram failed for ${stock.sym}: ${e.message}`, "lwarn");
  }
}

// â”€â”€ Tickers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const TICKERS = [
  {sym:"AAPL",name:"Apple"},       {sym:"MSFT",name:"Microsoft"},
  {sym:"NVDA",name:"NVIDIA"},      {sym:"AMZN",name:"Amazon"},
  {sym:"META",name:"Meta"},        {sym:"TSLA",name:"Tesla"},
  {sym:"GOOGL",name:"Alphabet"},   {sym:"AVGO",name:"Broadcom"},
  {sym:"COST",name:"Costco"},      {sym:"NFLX",name:"Netflix"},
  {sym:"AMD",name:"AMD"},          {sym:"ADBE",name:"Adobe"},
  {sym:"QCOM",name:"Qualcomm"},    {sym:"INTC",name:"Intel"},
  {sym:"TXN",name:"Texas Instr."}, {sym:"INTU",name:"Intuit"},
  {sym:"AMAT",name:"Applied Mat"}, {sym:"MU",name:"Micron"},
  {sym:"LRCX",name:"Lam Res."},    {sym:"KLAC",name:"KLA Corp"},
  {sym:"PANW",name:"Palo Alto"},   {sym:"CRWD",name:"CrowdStrike"},
  {sym:"CSCO",name:"Cisco"},       {sym:"PEP",name:"PepsiCo"},
];

// â”€â”€ Finnhub helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function fhQuote(sym) {
  const r = await fetch(`${FH_BASE}/quote?symbol=${sym}&token=${FH}`);
  if (!r.ok) throw new Error(`FH quote ${r.status}`);
  const d = await r.json();
  if (!d.c || d.c === 0) throw new Error("No price");
  return d; // {c:current, o:open, h:high, l:low, pc:prev_close, dp:chg%, d:chg}
}

async function fhCandles5m(sym) {
  // 5-min candles for today (last 7 hours = intraday VWAP approx)
  const to   = Math.floor(Date.now()/1000);
  const from = to - 7*3600;
  const r = await fetch(`${FH_BASE}/stock/candle?symbol=${sym}&resolution=5&from=${from}&to=${to}&token=${FH}`);
  if (!r.ok) return null;
  const d = await r.json();
  if (d.s !== "ok" || !d.c || d.c.length < 3) return null;
  return d; // {c,h,l,o,v,t}
}

// â”€â”€ Yahoo Finance helpers (replaces Alpha Vantage â€” no key, no rate limit) â”€
const yhCache = {};

async function yhDaily(sym) {
  if (yhCache[sym]) return yhCache[sym];
  // fetch 3 months of daily data â€” enough for 20-day vol avg + 14-day ATR
  const url = `https://corsproxy.io/?${encodeURIComponent(`${YH_BASE}/${sym}?interval=1d&range=3mo`)}`;
  const r = await fetch(url);
  if (!r.ok) throw new Error(`YH ${r.status}`);
  const json = await r.json();
  const q = json?.chart?.result?.[0];
  if (!q) throw new Error("YH no data");
  const closes  = q.indicators.quote[0].close.map(v => v ?? 0);
  const volumes = q.indicators.quote[0].volume.map(v => v ?? 0);
  const highs   = q.indicators.quote[0].high.map(v => v ?? 0);
  const lows    = q.indicators.quote[0].low.map(v => v ?? 0);
  const result  = {closes, volumes, highs, lows};
  yhCache[sym]  = result;
  return result;
}

// â”€â”€ Indicator helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function sma(arr, n) {
  if (arr.length < n) return null;
  return arr.slice(-n).reduce((a,b)=>a+b,0)/n;
}

function avgVolume(volumes, n=20) {
  if (volumes.length < n) return null;
  return volumes.slice(-n-1, -1).reduce((a,b)=>a+b,0)/n; // exclude today
}

function avgTrueRange(highs, lows, closes, n=14) {
  if (closes.length < n+1) return null;
  const trs = [];
  for (let i = closes.length-n; i < closes.length; i++) {
    trs.push(Math.max(highs[i]-lows[i], Math.abs(highs[i]-closes[i-1]), Math.abs(lows[i]-closes[i-1])));
  }
  return trs.reduce((a,b)=>a+b,0)/n;
}

function calcVWAP(candles) {
  // VWAP = sum(typical_price * volume) / sum(volume)
  if (!candles) return null;
  let tpv = 0, vol = 0;
  for (let i=0; i<candles.c.length; i++) {
    const tp = (candles.h[i]+candles.l[i]+candles.c[i])/3;
    tpv += tp * candles.v[i];
    vol += candles.v[i];
  }
  return vol > 0 ? tpv/vol : null;
}

function intradayVolume(candles) {
  if (!candles) return 0;
  return candles.v.reduce((a,b)=>a+b,0);
}

// â”€â”€ Scoring (day trading momentum, max 14 pts) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const MAX_PTS = 14;

function score(d) {
  let pts = 0;
  const tags = [];

  // 1. Intraday % change â€” core momentum signal (max 4)
  if (d.chgPct >= 3)      { pts += 4; tags.push({t:"ğŸ”¥ +" +d.chgPct.toFixed(1)+"%",c:"tg"}); }
  else if (d.chgPct >= 2) { pts += 3; tags.push({t:"â–² +"+d.chgPct.toFixed(1)+"%",c:"tg"}); }
  else if (d.chgPct >= 1) { pts += 2; tags.push({t:"â–² +"+d.chgPct.toFixed(1)+"%",c:"ty"}); }
  else if (d.chgPct >= 0) { pts += 1; tags.push({t:"â†’ +"+d.chgPct.toFixed(1)+"%",c:"ta"}); }
  else                    {           tags.push({t:"â–¼ "+d.chgPct.toFixed(1)+"%",c:"tr"}); }

  // 2. Volume surge vs 20-day avg (max 3)
  if (d.volRatio >= 2.5)     { pts += 3; tags.push({t:"VOL "+d.volRatio.toFixed(1)+"x ğŸš€",c:"tg"}); }
  else if (d.volRatio >= 1.5){ pts += 2; tags.push({t:"VOL "+d.volRatio.toFixed(1)+"x â†‘",c:"ty"}); }
  else if (d.volRatio >= 1.1){ pts += 1; tags.push({t:"VOL "+d.volRatio.toFixed(1)+"x",c:"ta"}); }
  else if (d.volRatio > 0)   {           tags.push({t:"VOL LOW "+d.volRatio.toFixed(1)+"x",c:"tr"}); }

  // 3. Relative strength vs SPY (max 2)
  if (d.relStr > 1.5)       { pts += 2; tags.push({t:"RS +"+d.relStr.toFixed(1)+"% vs SPY",c:"tg"}); }
  else if (d.relStr > 0)    { pts += 1; tags.push({t:"RS +"+d.relStr.toFixed(1)+"% vs SPY",c:"ty"}); }
  else                      {           tags.push({t:"RS "+d.relStr.toFixed(1)+"% vs SPY",c:"tr"}); }

  // 4. Gap up held â€” opened above prev close (max 2)
  if (d.gapPct >= 1.5)      { pts += 2; tags.push({t:"GAP UP +"+d.gapPct.toFixed(1)+"%",c:"tp"}); }
  else if (d.gapPct >= 0.3) { pts += 1; tags.push({t:"GAP +"+d.gapPct.toFixed(1)+"%",c:"ta"}); }

  // 5. Price above VWAP (max 2)
  if (d.aboveVWAP === true)  { pts += 2; tags.push({t:"ABOVE VWAP âœ“",c:"tg"}); }
  else if (d.aboveVWAP===false){         tags.push({t:"BELOW VWAP",c:"tr"}); }

  // 6. Range expansion vs ATR (max 1)
  if (d.rangeRatio >= 1.3)  { pts += 1; tags.push({t:"RANGE EXP "+d.rangeRatio.toFixed(1)+"x ATR",c:"to"}); }

  return {pts, tags};
}

// â”€â”€ Signal label â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function sigLabel(pts) {
  if (pts >= 11) return `<span style="color:var(--green);font-weight:700">ğŸ”¥ STRONG MOMENTUM</span>`;
  if (pts >= 8)  return `<span style="color:var(--yellow);font-weight:700">âš¡ MOMENTUM</span>`;
  if (pts >= 5)  return `<span style="color:var(--accent);font-weight:700">â—ˆ WATCH</span>`;
  return `<span style="color:var(--dim)">â—‡ WEAK</span>`;
}

// â”€â”€ Log â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function log(msg, cls="") {
  const box = document.getElementById("logBox");
  box.classList.add("on");
  const d = document.createElement("div");
  d.textContent = msg;
  d.className = cls;
  box.appendChild(d);
  box.scrollTop = box.scrollHeight;
}

// â”€â”€ Render â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function rankBarColor(i) {
  if (i===0) return "#f59e0b";
  if (i===1) return "#94a3b8";
  if (i===2) return "#b45309";
  return "#0d1f2d";
}
function rankNumCls(i) {
  if (i===0) return "gold"; if (i===1) return "silver"; if (i===2) return "bronze";
  return "";
}

function renderRows(data) {
  const tbody = document.getElementById("tbody");
  if (!data.length) {
    tbody.innerHTML = `<div class="msg">No results â€” try rescanning</div>`;
    return;
  }
  tbody.innerHTML = data.slice(0,10).map((d,i)=>{
    const s = d._score;
    const scoreColor = s.pts>=11?"#00ff88":s.pts>=8?"#ffd700":s.pts>=5?"#00d4ff":"#3a5a6a";
    const chgCls = d.chgPct>=0?"pos":"neg";
    const chgSign = d.chgPct>=0?"â–²":"â–¼";
    const vrFill = d.volRatio>0?Math.min(100,(d.volRatio/3)*100):0;
    const vrColor = d.volRatio>=2?"bf-green":d.volRatio>=1.2?"bf-yellow":"bf-red";
    const rsFill  = Math.min(100,Math.max(0,(d.relStr+3)/6*100));
    const rsColor = d.relStr>0?"bf-green":"bf-red";
    const gapColor= d.gapPct>=1?"bf-green":d.gapPct>=0?"bf-yellow":"bf-red";
    const rrFill  = d.rangeRatio>0?Math.min(100,(d.rangeRatio/2)*100):0;
    const vwapLabel = d.aboveVWAP===true
      ? `<span style="color:var(--green);font-weight:700">ABOVE</span>`
      : d.aboveVWAP===false
      ? `<span style="color:var(--red)">BELOW</span>`
      : `<span style="color:var(--dim)">â€”</span>`;
    const tagsHtml = s.tags.map(t=>`<span class="tag ${t.c}">${t.t}</span>`).join("");

    return `<div class="trow fadeIn" style="animation-delay:${i*0.06}s">
      <div class="rankbar" style="background:${rankBarColor(i)}"></div>
      <div class="cell"><span class="rnum ${rankNumCls(i)}">${i+1}</span></div>
      <div class="cell col"><span class="tsym">${d.sym}</span><span class="tname">${d.name}</span></div>
      <div class="cell col">
        ${sigLabel(s.pts)}
        <div class="sig-tags">${tagsHtml}</div>
      </div>
      <div class="cell col">
        <span class="pval">$${d.price.toLocaleString('en-US',{minimumFractionDigits:2,maximumFractionDigits:2})}</span>
        <span class="chg ${chgCls}">${chgSign} ${Math.abs(d.chgPct).toFixed(2)}%</span>
      </div>
      <div class="cell col">
        <span style="font-size:14px;font-weight:700" class="chg ${chgCls}">${chgSign}${Math.abs(d.chgPct).toFixed(2)}%</span>
        <div class="bar-mini"><div class="bar-fill ${d.chgPct>=0?'bf-green':'bf-red'}" style="width:${Math.min(100,Math.abs(d.chgPct)/5*100)}%"></div></div>
      </div>
      <div class="cell col">
        <span style="font-size:13px;font-weight:700;color:${d.volRatio>=1.5?'var(--yellow)':d.volRatio>=1?'var(--text)':'var(--dim)'}">${d.volRatio>0?d.volRatio.toFixed(2)+"x":"â€”"}</span>
        <div class="bar-mini"><div class="bar-fill ${vrColor}" style="width:${vrFill}%"></div></div>
      </div>
      <div class="cell col">
        <span style="font-size:13px;font-weight:700;color:${d.relStr>0?'var(--green)':'var(--red)'}">${d.relStr>0?"+":""}${d.relStr.toFixed(2)}%</span>
        <div class="bar-mini"><div class="bar-fill ${rsColor}" style="width:${rsFill}%"></div></div>
      </div>
      <div class="cell col">
        <span style="font-size:13px;font-weight:700;color:${d.gapPct>=1?'var(--green)':d.gapPct>=0?'var(--yellow)':'var(--red)'}">${d.gapPct>=0?"+":""}${d.gapPct.toFixed(2)}%</span>
        <div class="bar-mini"><div class="bar-fill ${gapColor}" style="width:${Math.min(100,Math.abs(d.gapPct)/4*100)}%"></div></div>
      </div>
      <div class="cell col">
        <span style="font-size:13px;font-weight:700;color:${d.rangeRatio>=1.3?'var(--orange)':'var(--dim)'}">${d.rangeRatio>0?d.rangeRatio.toFixed(2)+"x ATR":"â€”"}</span>
        <div class="bar-mini"><div class="bar-fill bf-orange" style="width:${rrFill}%"></div></div>
      </div>
      <div class="cell">${vwapLabel}</div>
      <div class="cell col">
        <span class="score-num" style="color:${scoreColor}">${s.pts}</span>
        <span class="score-denom">/${MAX_PTS}</span>
        <div class="score-bar"><div class="score-fill" style="width:${(s.pts/MAX_PTS)*100}%"></div></div>
      </div>
    </div>`;
  }).join("");
}

function updateStats(all, spyChg) {
  document.getElementById("sScanned").textContent  = all.length;
  document.getElementById("sGainers").textContent  = all.filter(d=>d.chgPct>=1).length;
  document.getElementById("sVolSurge").textContent = all.filter(d=>d.volRatio>=1.5).length;
  document.getElementById("sRS").textContent       = all.filter(d=>d.relStr>0).length;
  document.getElementById("sGapUp").textContent    = all.filter(d=>d.gapPct>=0.5).length;
  const avg = all.length ? (all.reduce((a,b)=>a+b.chgPct,0)/all.length).toFixed(2) : "â€”";
  const avgEl = document.getElementById("sAvgChg");
  avgEl.textContent = avg !== "â€”" ? (avg>=0?"+":"")+avg+"%" : "â€”";
  avgEl.className = "snum " + (parseFloat(avg)>=0?"g":"r");

  // Regime
  const spyEl  = document.getElementById("spyReg");
  const mktEl  = document.getElementById("mktRegime");
  if (spyChg !== null) {
    spyEl.textContent = (spyChg>=0?"+":"")+spyChg.toFixed(2)+"%";
    spyEl.style.color = spyChg>=0?"var(--green)":"var(--red)";
    mktEl.textContent = spyChg>=0.3?"BULLISH DAY":spyChg<=-0.3?"BEARISH DAY":"CHOPPY";
    mktEl.style.color = spyChg>=0.3?"var(--green)":spyChg<=-0.3?"var(--red)":"var(--yellow)";
  }
}

// â”€â”€ Main scan â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function runScan() {
  const btn = document.getElementById("scanBtn");
  btn.disabled = true; btn.textContent = "SCANNING...";
  document.getElementById("logBox").innerHTML = "";
  document.getElementById("logBox").className = "log on";
  document.getElementById("progWrap").className = "prog-wrap on";
  document.getElementById("tbody").innerHTML = `<div class="msg"><span class="spin"></span>FETCHING LIVE MOMENTUM DATA...</div>`;
  document.getElementById("mdot").style.background = "var(--yellow)";
  document.getElementById("mtext").style.color = "var(--yellow)";
  document.getElementById("mtext").textContent = "SCANNING";

  const t0 = Date.now();

  // â”€â”€ Step 1: get SPY as market baseline (Finnhub quote only â€” 1 req) â”€â”€
  let spyChg = null;
  let spyChgPct = 0;
  try {
    const spy = await fhQuote("SPY");
    spyChg = spy.dp;
    spyChgPct = spy.dp || 0;
    document.getElementById("spyVol").textContent = "Live";
    document.getElementById("spyVol").style.color = "var(--accent)";
    log(`âœ“ SPY baseline: ${spyChg>=0?"+":""}${spyChg.toFixed(2)}% today`, "lok");
  } catch(e) {
    log(`âš  SPY fetch failed: ${e.message}`, "lwarn");
  }

  const results = [];
  const total = TICKERS.length;

  // â”€â”€ Step 2: For each ticker, fetch Finnhub quote (fast, no rate limit issues)
  //           then AV daily for vol ratio + ATR (cached after first use)
  log(`â–º Scanning ${total} stocks â€” Finnhub quotes + AV vol history`, "linfo");

  for (let i = 0; i < total; i++) {
    const t = TICKERS[i];
    const pct = Math.round(((i+1)/total)*100);
    document.getElementById("progLbl").textContent = `${i+1}/${total} â€” ${t.sym}`;
    document.getElementById("progPct").textContent = pct+"%";
    document.getElementById("progFill").style.width = pct+"%";

    try {
      // Finnhub quote â€” fast, no rate limit on free tier for quotes
      const q = await fhQuote(t.sym);

      const price   = q.c;
      const chgPct  = q.dp || 0;
      const open    = q.o;
      const prevClose = q.pc;
      const high    = q.h;
      const low     = q.l;

      // Gap % = (open - prevClose) / prevClose * 100
      const gapPct = prevClose > 0 ? (open - prevClose)/prevClose*100 : 0;

      // Intraday range as fraction of price
      const intradayRange = high - low;

      // Relative strength vs SPY
      const relStr = chgPct - spyChgPct;

      // Try 5-min candles for VWAP (best effort â€” Finnhub free allows this)
      const candles5m = await fhCandles5m(t.sym);
      const vwap = calcVWAP(candles5m);
      const aboveVWAP = vwap !== null ? price > vwap : null;
      const intradayVol = intradayVolume(candles5m);

      // Yahoo Finance for vol ratio + ATR (no rate limit, no API key)
      let volRatio = 0, rangeRatio = 0;
      try {
        const yh = await yhDaily(t.sym);
        const avgVol = avgVolume(yh.volumes, 20);
        const todayVol = intradayVol > 0 ? intradayVol : (yh.volumes[yh.volumes.length-1] || 0);
        volRatio = avgVol > 0 ? todayVol/avgVol : 0;
        const atr = avgTrueRange(yh.highs, yh.lows, yh.closes, 14);
        rangeRatio = (atr > 0 && intradayRange > 0) ? intradayRange/atr : 0;
      } catch(yhErr) {
        log(`âš  Yahoo data unavailable for ${t.sym}: ${yhErr.message}`, "lwarn");
        // continue without vol data â€” Finnhub data is still scored
      }

      const d = {sym:t.sym, name:t.name, price, chgPct, open, prevClose,
                 high, low, gapPct, relStr, volRatio, rangeRatio,
                 vwap, aboveVWAP, intradayVol};
      const s = score(d);
      d._score = s;
      results.push(d);

      log(`âœ“ ${t.sym.padEnd(6)} | ${chgPct>=0?"+":""}${chgPct.toFixed(2)}% | VOL:${volRatio>0?volRatio.toFixed(1)+"x":"â€”"} | RS:${relStr>=0?"+":""}${relStr.toFixed(1)}% | VWAP:${aboveVWAP===true?"â–²":aboveVWAP===false?"â–¼":"â€”"} | ${s.pts}/${MAX_PTS}pts`, "lok");

    } catch(e) {
      log(`âœ— ${t.sym} â€” ${e.message}`, "lerr");
    }

    // 220ms between stocks â€” Finnhub free allows 30 req/s for quotes
    if (i < total-1) await new Promise(r=>setTimeout(r, 220));
  }

  // â”€â”€ Sort: score desc, then chgPct desc (prefer bigger movers at same score)
  results.sort((a,b)=> b._score.pts !== a._score.pts
    ? b._score.pts - a._score.pts
    : b.chgPct - a.chgPct);

  renderRows(results);
  updateStats(results, spyChg);

  const elapsed = ((Date.now()-t0)/1000).toFixed(1);
  document.getElementById("scanTime").textContent = elapsed+"s";
  document.getElementById("scanTime").style.color = "var(--accent)";
  document.getElementById("footTime").textContent =
    `Scanned ${results.length} stocks in ${elapsed}s Â· Top: ${results[0]?.sym||"â€”"} (${results[0]?._score.pts||0}/${MAX_PTS}) Â· ${new Date().toLocaleTimeString()}`;

  document.getElementById("mdot").style.background = "var(--green)";
  document.getElementById("mtext").style.color = "var(--green)";
  document.getElementById("mtext").textContent = "DONE";
  document.getElementById("progWrap").className = "prog-wrap";
  document.getElementById("mtime").textContent = new Date().toLocaleTimeString();

  if (results[0]) log(`\nâ–º TOP PICK: ${results[0].sym} â€” Score ${results[0]._score.pts}/${MAX_PTS} Â· +${results[0].chgPct.toFixed(2)}%`, "linfo");

  // â”€â”€ Send Telegram alerts for stocks scoring 8+ (MOMENTUM or STRONG MOMENTUM)
  if (TG_TOKEN !== "YOUR_BOT_TOKEN_HERE") {
    const alerts = results.filter(d => d._score.pts >= 8);
    if (alerts.length) {
      log(`\nğŸ“² Sending Telegram alerts for ${alerts.length} buy signal(s)...`, "linfo");
      for (const stock of alerts) {
        await sendTelegramAlert(stock);
        await new Promise(r => setTimeout(r, 300)); // small delay between messages
      }
    } else {
      log(`ğŸ“² No stocks hit the alert threshold (8+ pts) this scan`, "lwarn");
    }
  }

  btn.disabled = false; btn.textContent = "â–¶ RESCAN";
}
</script>
</body>
</html>
